<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #searchInput {
            width: 100%;
            padding: 10px;
            font-size: 16px;
        }
        #suggestions {
            border: 1px solid #ccc;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .suggestion-item img {
            max-width: 50px;
            margin-right: 10px;
        }
        .suggestion-item button {
            padding: 5px 10px;
            background-color: green;
            color: white;
            border: none;
            cursor: pointer;
        }
        .suggestion-item button:hover {
            background-color: darkgreen;
        }
    </style>
</head>
<body>

<h1>Product Search</h1>
<input type="text" id="searchInput" placeholder="Search for products..." oninput="searchProducts()" />

<div id="suggestions"></div>

<script>
    // Používáme corsproxy.io pro obcházení CORS
    const proxyUrl = 'https://corsproxy.io/?';
    const xmlUrl = 'https://www.henrymorgan.cz/export-full-products-TGp7rYDROL.xml';

    let products = [];

    async function loadXML() {
        try {
            const response = await fetch(proxyUrl + encodeURIComponent(xmlUrl));
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.text();  // Získáme data jako text
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(data, "application/xml");
            parseProducts(xmlDoc);
        } catch (error) {
            console.error('Error fetching the XML file:', error);
        }
    }

    function parseProducts(xmlDoc) {
        const items = xmlDoc.getElementsByTagName("PRODUCT");
        for (let i = 0; i < items.length; i++) {
            const descriptions = items[i].getElementsByTagName("DESCRIPTIONS")[0];
            const descriptionNodes = descriptions.getElementsByTagName("DESCRIPTION");
            for (let j = 0; j < descriptionNodes.length; j++) {
                const lang = descriptionNodes[j].getAttribute("language");
                const title = descriptionNodes[j].getElementsByTagName("TITLE")[0].textContent;
                const url = descriptionNodes[j].getElementsByTagName("URL")[0].textContent;
                const shortDescription = descriptionNodes[j].getElementsByTagName("SHORT_DESCRIPTION")[0].textContent.trim();
                const longDescription = descriptionNodes[j].getElementsByTagName("LONG_DESCRIPTION")[0].textContent.trim();

                products.push({
                    language: lang,
                    title,
                    url,
                    shortDescription,
                    longDescription
                });
            }
        }
    }

    function normalizeText(text) {
        return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function getWordSimilarity(word1, word2) {
        const word1Length = word1.length;
        const word2Length = word2.length;
        const minLength = Math.min(word1Length, word2Length);
        let matchCount = 0;

        for (let i = 0; i < minLength; i++) {
            if (word1[i] === word2[i]) matchCount++;
        }

        return (matchCount / Math.max(word1Length, word2Length)) * 100;
    }

    function searchProducts() {
        const searchTerm = normalizeText(document.getElementById("searchInput").value);
        const suggestionsContainer = document.getElementById("suggestions");
        suggestionsContainer.innerHTML = '';

        if (searchTerm.length < 3) {
            return;
        }

        // Získáme aktuální jazyk z proměnné upgates.language nebo defaultně "en"
        const language = window.upgates && window.upgates.language ? window.upgates.language : 'en';
        const filteredProducts = products.filter(product => {
            if (product.language !== language) {
                return false;
            }

            const searchTermWords = searchTerm.split(/\s+/);
            const titleWords = normalizeText(product.title).split(/\s+/);
            const shortDescWords = normalizeText(product.shortDescription).split(/\s+/);
            const longDescWords = normalizeText(product.longDescription).split(/\s+/);

            const wordMatches = (words) => {
                return words.some(word => {
                    return searchTermWords.some(term => {
                        const similarity = getWordSimilarity(term, word);
                        return similarity >= 80 && term.length <= word.length;
                    });
                });
            };

            return wordMatches(titleWords) || wordMatches(shortDescWords) || wordMatches(longDescWords);
        });

        filteredProducts.forEach(product => {
            const suggestionItem = document.createElement("div");
            suggestionItem.classList.add("suggestion-item");

            const productInfo = document.createElement("div");
            const productTitle = document.createElement("h4");
            productTitle.textContent = product.title;

            const productShortDesc = document.createElement("p");
            productShortDesc.textContent = `Short Description: ${product.shortDescription}`;

            productInfo.appendChild(productTitle);
            productInfo.appendChild(productShortDesc);

            const buyButton = document.createElement("button");
            buyButton.textContent = "Buy";
            buyButton.onclick = () => {
                window.location.href = product.url;
            };

            suggestionItem.appendChild(productInfo);
            suggestionItem.appendChild(buyButton);
            suggestionsContainer.appendChild(suggestionItem);
        });
    }

    // Načteme produkty při načtení stránky
    window.onload = loadXML;
</script>
23
</body>
</html>
